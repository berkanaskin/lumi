<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="description" content="Lumi - Film ve dizi keşfi için premium platform">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lumi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="index_lumi.css">
</head>

<body>
    <!-- Ambient Glows (The Soul) -->
    <div class="ambient-glow ambient-glow-violet"></div>
    <div class="ambient-glow ambient-glow-blue"></div>

    <div class="app">
        <!-- ============================================
             STICKY SEARCH HEADER
             ============================================ -->
        <div class="sticky-search-header">
            <div class="status-bar-gradient"></div>
            <span class="brand-logo">LUMI</span>
            <div class="search-pill-container">
                <div class="search-pill" id="search-trigger">
                    <span class="material-symbols-outlined search-icon">search</span>
                    <input type="text" id="search-input" placeholder="Search..." autocomplete="off" readonly>
                </div>
            </div>
        </div>

        <!-- ============================================
             VIEW: HOME (Infinity Feed)
             ============================================ -->
        <section id="view-home" class="view active">
            <!-- Masonry Infinity Grid -->
            <div class="masonry-grid no-scrollbar scroll-touch" id="feed-grid">
                <!-- Content will be dynamically loaded -->
                <div class="loading-state" id="feed-loading" style="display: flex; grid-column: 1 / -1; height: 100vh;">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- ============================================
             VIEW: FAVORITES (Listem)
             ============================================ -->
        <section id="view-favorites" class="view">
            <div class="favorites-header">
                <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: var(--space-lg);">
                    <span class="material-symbols-outlined"
                        style="vertical-align: middle; margin-right: 8px;">bookmark</span>
                    Listem
                </h1>

                <div class="favorites-tabs">
                    <button class="fav-tab active" data-list="liked">
                        <span class="material-symbols-outlined" style="font-size: 18px;">favorite</span>
                        Beğendiklerim
                    </button>
                    <button class="fav-tab" data-list="watchlist">
                        <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
                        İzleyeceklerim
                    </button>
                </div>
            </div>

            <div class="favorites-grid" id="favorites-grid"></div>

            <div class="empty-state" id="empty-list-message" style="display: none;">
                <span class="material-symbols-outlined"
                    style="font-size: 64px; opacity: 0.3; margin-bottom: var(--space-md);">bookmark</span>
                <p>Henüz içerik eklemediniz</p>
                <small style="color: var(--text-muted);">Film ve dizileri beğenin veya izleyeceklerinize ekleyin</small>
            </div>
        </section>

        <!-- ============================================
             VIEW: PROFILE
             ============================================ -->
        <section id="view-profile" class="view">
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <div class="profile-avatar-glow"></div>
                    <div class="profile-avatar" id="profile-avatar">
                        <img src="https://via.placeholder.com/120" alt="Avatar" id="profile-avatar-img">
                    </div>
                </div>
                <h1 class="profile-name" id="profile-name">Misafir</h1>
                <div class="profile-badge" id="profile-badge" style="display: none;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">verified</span>
                    LUMI PREMIUM
                </div>
            </div>

            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-outlined">movie</span>
                    </div>
                    <div class="stat-label">İzlenen Film</div>
                    <div class="stat-value" id="stat-movies">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-outlined">schedule</span>
                    </div>
                    <div class="stat-label">Toplam Süre</div>
                    <div class="stat-value" id="stat-hours">0h</div>
                </div>
            </div>

            <div id="profile-content" style="padding: 0 var(--space-lg);"></div>
        </section>

        <!-- ============================================
             FLOATING BOTTOM NAVIGATION (3 Icons)
             ============================================ -->
        <nav class="bottom-nav" id="bottom-nav">
            <button class="nav-item active" data-page="home">
                <span class="material-symbols-outlined">home</span>
            </button>
            <button class="nav-item" data-page="favorites">
                <span class="material-symbols-outlined">favorite</span>
            </button>
            <button class="nav-item" data-page="profile">
                <span class="material-symbols-outlined">person</span>
            </button>
        </nav>
    </div>

    <!-- ============================================
         SEARCH OVERLAY
         ============================================ -->
    <div class="search-overlay" id="search-overlay">
        <div class="search-header">
            <div class="search-input-wrapper">
                <div class="search-box">
                    <div class="search-box-inner">
                        <span class="material-symbols-outlined"
                            style="color: var(--text-muted); margin-right: 8px;">search</span>
                        <input type="text" id="search-input-overlay" placeholder="Film veya dizi ara..."
                            autocomplete="off"
                            style="flex: 1; background: none; border: none; color: white; font-size: 16px; outline: none;">
                        <button class="search-clear" id="search-clear" style="display: none;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">cancel</span>
                        </button>
                    </div>
                </div>
                <button class="search-cancel" id="search-cancel">İptal</button>
            </div>

            <!-- Filter Chips -->
            <div class="filter-chips" id="search-filter-chips">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="movie">Movies</button>
                <button class="filter-chip" data-filter="tv">TV Shows</button>
                <button class="filter-chip" data-filter="person">People</button>
            </div>
        </div>

        <div id="search-results-container" style="flex: 1; overflow-y: auto; padding: var(--space-md);"
            class="no-scrollbar scroll-touch">
            <h3
                style="font-size: 0.875rem; font-weight: 600; color: var(--text-muted); margin-bottom: var(--space-md); padding: 0 4px;">
                Top Results</h3>
            <div class="search-results-grid" id="search-grid"></div>
        </div>
    </div>

    <!-- ============================================
         DETAIL MODAL (Bottom Sheet)
         ============================================ -->
    <div class="modal" id="detail-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-handle"></div>
            <button class="modal-close" id="modal-close">
                <span class="material-symbols-outlined" style="font-size: 20px;">close</span>
            </button>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <!-- ============================================
         LOGIN MODAL
         ============================================ -->
    <div class="login-modal" id="login-modal">
        <div class="login-modal-content">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: var(--space-sm);">Hoş Geldiniz</h2>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Devam etmek için giriş yapın</p>
            <div class="social-login-btns">
                <button class="social-btn google" data-provider="google">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                            fill="#4285F4" />
                        <path
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                            fill="#34A853" />
                        <path
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                            fill="#FBBC05" />
                        <path
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                            fill="#EA4335" />
                    </svg>
                    <span>Google ile devam et</span>
                </button>
                <button class="social-btn apple" data-provider="apple">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                    </svg>
                    <span>Apple ile devam et</span>
                </button>
            </div>
            <button
                style="margin-top: var(--space-lg); width: 100%; padding: var(--space-md); background: transparent; border: 1px solid var(--glass-border); border-radius: var(--radius-lg); color: var(--text-secondary); cursor: pointer;"
                id="login-modal-close">Kapat</button>
        </div>
    </div>

    <!-- Hidden elements for legacy app.js compatibility -->
    <div style="display: none;">
        <select id="language-select"></select>
        <div id="lang-dropdown-container"></div>
        <div id="notification-container"></div>
        <button id="theme-toggle"></button>
        <div id="auth-area"></div>
        <button id="login-btn"></button>
        <div id="results-grid"></div>
        <div id="no-results"></div>
        <div id="loading"></div>
        <div id="trending-slider"></div>
        <div id="new-releases-slider"></div>
        <div id="classics-slider"></div>
        <div id="suggested-slider"></div>
        <div id="discover-grid"></div>
        <div id="trending-section"></div>
        <div id="new-releases-section"></div>
        <div id="classics-section"></div>
        <div id="suggested-section"></div>
    </div>

    <script src="config.js"></script>
    <script src="i18n.js"></script>
    <script src="services/auth.js"></script>
    <script src="services/notifications.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
    <script>
        // ============================================
        // LUMI SPA NAVIGATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            const feedGrid = document.getElementById('feed-grid');
            const searchTrigger = document.getElementById('search-trigger');
            const searchOverlay = document.getElementById('search-overlay');
            const searchInputOverlay = document.getElementById('search-input-overlay');
            const searchCancel = document.getElementById('search-cancel');
            const searchClear = document.getElementById('search-clear');

            // Bottom Nav Click Handlers
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const page = this.dataset.page;
                    switchView('view-' + page);

                    // Update nav state
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search Trigger - Open Overlay
            searchTrigger?.addEventListener('click', function () {
                searchOverlay.classList.add('active');
                searchInputOverlay.focus();
            });

            // Search Cancel - Close Overlay
            searchCancel?.addEventListener('click', function () {
                searchOverlay.classList.remove('active');
                searchInputOverlay.value = '';
                searchClear.style.display = 'none';
            });

            // Search Input - Show/Hide Clear Button
            searchInputOverlay?.addEventListener('input', function () {
                searchClear.style.display = this.value ? 'block' : 'none';
                // Trigger search
                if (this.value.length >= 2) {
                    handleOverlaySearch(this.value);
                }
            });

            // Search Clear
            searchClear?.addEventListener('click', function () {
                searchInputOverlay.value = '';
                this.style.display = 'none';
                document.getElementById('search-grid').innerHTML = '';
            });

            // Filter Chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    const group = this.parentElement;
                    group.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    // Re-search with new filter
                    if (searchInputOverlay.value) {
                        handleOverlaySearch(searchInputOverlay.value);
                    }
                });
            });

            // Favorites Tab Toggle
            document.querySelectorAll('.fav-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.fav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    // Load corresponding list
                    loadFavoritesList(this.dataset.list);
                });
            });

            // Modal Backdrop Close
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.addEventListener('click', function () {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Modal Close Buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function () {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Login Modal Close
            document.getElementById('login-modal-close')?.addEventListener('click', function () {
                document.getElementById('login-modal').classList.remove('active');
            });

            // Load Infinity Feed
            loadInfinityFeed();
        });

        // ============================================
        // SPA VIEW ROUTER
        // ============================================
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(el => {
                el.classList.remove('active');
            });

            const target = document.getElementById(viewId);
            if (target) {
                target.classList.add('active');
            }

            // Close search overlay if open
            document.getElementById('search-overlay')?.classList.remove('active');

            // Load content for specific views
            if (viewId === 'view-favorites') {
                loadFavoritesList('liked');
            } else if (viewId === 'view-profile') {
                loadProfileData();
            }
        }

        // ============================================
        // INFINITY FEED - MIXED CONTENT
        // ============================================
        async function loadInfinityFeed() {
            const feedGrid = document.getElementById('feed-grid');
            const loadingEl = document.getElementById('feed-loading');

            try {
                // Fetch from multiple endpoints
                const [trending, nowPlaying, topRated] = await Promise.all([
                    API.getTrending ? API.getTrending() : fetch(`https://api.themoviedb.org/3/trending/all/week?api_key=${CONFIG.TMDB_API_KEY}&language=tr-TR`).then(r => r.json()),
                    API.getNowPlaying ? API.getNowPlaying() : fetch(`https://api.themoviedb.org/3/movie/now_playing?api_key=${CONFIG.TMDB_API_KEY}&language=tr-TR`).then(r => r.json()),
                    API.getTopRated ? API.getTopRated() : fetch(`https://api.themoviedb.org/3/movie/top_rated?api_key=${CONFIG.TMDB_API_KEY}&language=tr-TR`).then(r => r.json())
                ]);

                // Combine and extract results
                let allContent = [
                    ...(trending.results || []),
                    ...(nowPlaying.results || []),
                    ...(topRated.results || [])
                ];

                // Filter out items without posters
                allContent = allContent.filter(item => item.poster_path);

                // Remove duplicates by ID
                const seen = new Set();
                allContent = allContent.filter(item => {
                    if (seen.has(item.id)) return false;
                    seen.add(item.id);
                    return true;
                });

                // Shuffle array (Fisher-Yates)
                for (let i = allContent.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allContent[i], allContent[j]] = [allContent[j], allContent[i]];
                }

                // Render masonry items
                feedGrid.innerHTML = allContent.map(item => `
                    <div class="masonry-item" data-id="${item.id}" data-type="${item.media_type || 'movie'}">
                        <img 
                            src="https://image.tmdb.org/t/p/w500${item.poster_path}" 
                            alt="${item.title || item.name}"
                            loading="lazy"
                            onerror="this.parentElement.style.display='none'"
                        >
                    </div>
                `).join('');

                // Add click handlers to open detail modal
                feedGrid.querySelectorAll('.masonry-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const id = this.dataset.id;
                        const type = this.dataset.type;
                        openDetailModal(id, type);
                    });
                });

            } catch (error) {
                console.error('Failed to load infinity feed:', error);
                feedGrid.innerHTML = `
                    <div class="empty-state" style="display: flex; grid-column: 1 / -1;">
                        <span class="material-symbols-outlined" style="font-size: 64px; opacity: 0.3;">error</span>
                        <p>İçerik yüklenemedi</p>
                    </div>
                `;
            }
        }

        // ============================================
        // SEARCH OVERLAY
        // ============================================
        let searchTimeout;
        async function handleOverlaySearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const searchGrid = document.getElementById('search-grid');
                const activeFilter = document.querySelector('.filter-chip.active')?.dataset.filter || 'all';

                try {
                    let endpoint = 'multi';
                    if (activeFilter === 'movie') endpoint = 'movie';
                    else if (activeFilter === 'tv') endpoint = 'tv';
                    else if (activeFilter === 'person') endpoint = 'person';

                    const response = await fetch(
                        `https://api.themoviedb.org/3/search/${endpoint}?api_key=${CONFIG.TMDB_API_KEY}&language=tr-TR&query=${encodeURIComponent(query)}`
                    );
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        searchGrid.innerHTML = data.results
                            .filter(item => item.poster_path || item.profile_path)
                            .slice(0, 20)
                            .map(item => {
                                const posterPath = item.poster_path || item.profile_path;
                                const title = item.title || item.name;
                                const year = (item.release_date || item.first_air_date || '').split('-')[0];
                                const rating = item.vote_average?.toFixed(1) || '';
                                const type = item.media_type === 'person' ? 'Actor' : (item.media_type === 'tv' ? 'TV Series' : year);

                                return `
                                    <div class="result-card" data-id="${item.id}" data-type="${item.media_type || 'movie'}">
                                        <div class="result-card-poster" style="background-image: url('https://image.tmdb.org/t/p/w342${posterPath}')"></div>
                                        <div class="result-card-info">
                                            <div class="result-card-title">${title}</div>
                                            <div class="result-card-meta">
                                                <span>${type}</span>
                                                ${rating ? `<span class="dot"></span><span class="result-card-rating"><span class="material-symbols-outlined">star</span>${rating}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');

                        // Add click handlers
                        searchGrid.querySelectorAll('.result-card').forEach(card => {
                            card.addEventListener('click', function () {
                                const id = this.dataset.id;
                                const type = this.dataset.type;
                                document.getElementById('search-overlay').classList.remove('active');
                                openDetailModal(id, type);
                            });
                        });
                    } else {
                        searchGrid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 48px; color: var(--text-muted);">
                                <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.3;">search_off</span>
                                <p>Sonuç bulunamadı</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                }
            }, 300);
        }

        // ============================================
        // DETAIL MODAL
        // ============================================
        async function openDetailModal(id, type) {
            const modal = document.getElementById('detail-modal');
            const modalBody = document.getElementById('modal-body');

            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading-state" style="display: flex; height: 300px;"><div class="spinner"></div></div>';

            try {
                // Fallback to direct API call
                const response = await fetch(
                    `https://api.themoviedb.org/3/${type}/${id}?api_key=${CONFIG.TMDB_API_KEY}&language=tr-TR&append_to_response=credits,videos,watch/providers`
                );
                const data = await response.json();

                const title = data.title || data.name;
                const year = (data.release_date || data.first_air_date || '').split('-')[0];
                const rating = data.vote_average?.toFixed(1) || 'N/A';
                const overview = data.overview || 'Açıklama bulunamadı.';
                const backdrop = data.backdrop_path
                    ? `https://image.tmdb.org/t/p/w780${data.backdrop_path}`
                    : (data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '');
                const runtime = data.runtime ? `${Math.floor(data.runtime / 60)}s ${data.runtime % 60}dk` : '';
                const genres = data.genres || [];

                // Get watch providers for Turkey
                const providers = data['watch/providers']?.results?.TR?.flatrate || [];

                // Get cast (first 6)
                const cast = data.credits?.cast?.slice(0, 6) || [];

                // Check if in favorites
                const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                const isFavorite = favorites.some(f => f.id == id);

                modalBody.innerHTML = `
                    <div class="detail-backdrop" style="background-image: url('${backdrop}');"></div>
                    
                    <div class="detail-header">
                        <h2 class="detail-title">${title}</h2>
                        <div class="detail-meta">
                            <span>${year}</span>
                            ${runtime ? `<span>${runtime}</span>` : ''}
                            <span class="detail-rating">
                                <span class="material-symbols-outlined">star</span>
                                ${rating}
                            </span>
                        </div>
                    </div>

                    ${genres.length ? `
                        <div class="detail-genres">
                            ${genres.map(g => `<span class="genre-pill">${g.name}</span>`).join('')}
                        </div>
                    ` : ''}

                    <p class="detail-overview">${overview}</p>

                    ${providers.length ? `
                        <div class="detail-providers">
                            <div class="detail-providers-title">Nerede İzlenir</div>
                            <div class="provider-logos">
                                ${providers.map(p => `
                                    <div class="provider-logo" style="background-image: url('https://image.tmdb.org/t/p/w92${p.logo_path}');" title="${p.provider_name}"></div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="detail-actions">
                        <button class="detail-btn detail-btn-secondary ${isFavorite ? 'active' : ''}" id="detail-fav-btn" data-id="${id}" data-type="${type}" data-title="${title}" data-poster="${data.poster_path || ''}">
                            <span class="material-symbols-outlined">${isFavorite ? 'favorite' : 'favorite_border'}</span>
                            ${isFavorite ? 'Favorilerde' : 'Favorile'}
                        </button>
                        <button class="detail-btn detail-btn-primary" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(title + ' izle')}', '_blank')">
                            <span class="material-symbols-outlined">play_arrow</span>
                            İzle
                        </button>
                    </div>

                    ${cast.length ? `
                        <div class="cast-section">
                            <h3 class="cast-title">Oyuncular</h3>
                            <div class="cast-list no-scrollbar">
                                ${cast.map(c => `
                                    <div class="cast-item">
                                        <div class="cast-avatar" style="background-image: url('${c.profile_path ? 'https://image.tmdb.org/t/p/w185' + c.profile_path : 'https://via.placeholder.com/72?text=' + c.name.charAt(0)}');"></div>
                                        <div class="cast-name">${c.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Add favorite button handler
                document.getElementById('detail-fav-btn')?.addEventListener('click', function () {
                    const favId = this.dataset.id;
                    const favType = this.dataset.type;
                    const favTitle = this.dataset.title;
                    const favPoster = this.dataset.poster;

                    let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
                    const existingIndex = favs.findIndex(f => f.id == favId);

                    if (existingIndex > -1) {
                        // Remove from favorites
                        favs.splice(existingIndex, 1);
                        this.classList.remove('active');
                        this.innerHTML = '<span class="material-symbols-outlined">favorite_border</span> Favorile';
                    } else {
                        // Add to favorites
                        favs.push({ id: favId, type: favType, title: favTitle, poster: favPoster });
                        this.classList.add('active');
                        this.innerHTML = '<span class="material-symbols-outlined">favorite</span> Favorilerde';
                    }

                    localStorage.setItem('favorites', JSON.stringify(favs));
                });

            } catch (error) {
                console.error('Failed to load detail:', error);
                modalBody.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 48px;">Detaylar yüklenemedi.</p>';
            }
        }

        // ============================================
        // FAVORITES LIST
        // ============================================
        function loadFavoritesList(listType) {
            const grid = document.getElementById('favorites-grid');
            const emptyMessage = document.getElementById('empty-list-message');

            // Get from localStorage
            const key = listType === 'liked' ? 'favorites' : 'watchlist';
            const items = JSON.parse(localStorage.getItem(key) || '[]');

            if (items.length === 0) {
                grid.innerHTML = '';
                emptyMessage.style.display = 'flex';
                return;
            }

            emptyMessage.style.display = 'none';
            grid.innerHTML = items.map(item => `
                <div class="result-card" data-id="${item.id}" data-type="${item.type}">
                    <div class="result-card-poster" style="background-image: url('https://image.tmdb.org/t/p/w342${item.poster}')"></div>
                    <div class="result-card-info">
                        <div class="result-card-title">${item.title}</div>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            grid.querySelectorAll('.result-card').forEach(card => {
                card.addEventListener('click', function () {
                    openDetailModal(this.dataset.id, this.dataset.type);
                });
            });
        }

        // ============================================
        // PROFILE DATA
        // ============================================
        function loadProfileData() {
            const user = window.AuthService?.getCurrentUser?.();
            const profileName = document.getElementById('profile-name');
            const profileBadge = document.getElementById('profile-badge');
            const profileAvatar = document.getElementById('profile-avatar-img');

            if (user) {
                profileName.textContent = user.name || 'Kullanıcı';
                if (user.photoURL) {
                    profileAvatar.src = user.photoURL;
                }
                if (user.tier === 'premium') {
                    profileBadge.style.display = 'inline-flex';
                }
            }

            // Load stats
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            document.getElementById('stat-movies').textContent = favorites.length;
        }

        // Override modal functions for compatibility
        window.openModal = function (type, id) {
            openDetailModal(id, type);
        };

        window.closeModal = function () {
            document.getElementById('detail-modal').classList.remove('active');
        };
    </script>
</body>

</html>